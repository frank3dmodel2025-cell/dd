<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visor AR Avanzado Realista</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/DeviceOrientationControls.js"></script>

<style>
body { margin:0; overflow:hidden; background:#f7f3ed;}
canvas{position:absolute; top:0; left:0; width:100%; height:100vh;}
.video-background{position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:5; display:none;}
#placement-dot{position:fixed; top:50%; left:50%; width:62px; height:62px; transform:translate(-50%,-50%); border-radius:50%; z-index:22; display:flex; align-items:center; justify-content:center;}
#placement-dot .inner{width:42px; height:42px; border-radius:50%; background:rgba(255,255,255,0.6); border:2px solid rgba(0,0,0,0.45);}
#placement-dot .pulse{position:absolute; width:100%; height:100%; border-radius:50%; background:radial-gradient(circle, rgba(0,128,0,0.12) 0%, rgba(0,128,0,0.02) 60%, rgba(0,128,0,0) 100%); animation:pulse 1.6s infinite;}
@keyframes pulse {0%{transform:scale(.95);opacity:1;}70%{transform:scale(1.4);opacity:0;}100%{opacity:0;}}
</style>
</head>
<body>

<video id="video-feed" class="video-background" autoplay playsinline></video>
<div id="placement-dot"><div class="pulse"></div><div class="inner"></div></div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/jsm/loaders/GLTFLoader.js';
import { DeviceOrientationControls } from 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/jsm/controls/DeviceOrientationControls.js';

let scene, camera, renderer, controls, loader;
let modelContainer = null;
let plane, light, shadowMaterial;
let videoElement = document.getElementById('video-feed');
let placementDot = document.getElementById('placement-dot');
let placedOnce = false;
let initialWorldPos = new THREE.Vector3();

const MODELS = {
  Duck: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF/Duck.gltf'
};

initScene();
startCamera();

function initScene() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.01, 100);
  camera.position.set(0,1.6,3);

  renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  document.body.appendChild(renderer.domElement);

  loader = new GLTFLoader();

  // Luz direccional para sombras
  light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(2,5,2);
  light.castShadow = true;
  light.shadow.mapSize.width = 1024;
  light.shadow.mapSize.height = 1024;
  light.shadow.camera.near = 0.5;
  light.shadow.camera.far = 20;
  scene.add(light);

  // Plano invisible para sombras
  shadowMaterial = new THREE.ShadowMaterial({opacity:0.3});
  plane = new THREE.Mesh(new THREE.PlaneGeometry(100,100), shadowMaterial);
  plane.rotation.x = -Math.PI/2;
  plane.position.y = 0;
  plane.receiveShadow = true;
  scene.add(plane);

  // Contenedor del modelo
  modelContainer = new THREE.Object3D();
  modelContainer.castShadow = true;
  modelContainer.receiveShadow = true;
  scene.add(modelContainer);

  loadModel('Duck');

  // Controles dispositivo
  controls = new DeviceOrientationControls(camera);
  controls.connect();

  window.addEventListener('resize', ()=> {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // Doble tap para colocar modelo
  renderer.domElement.addEventListener('touchend', (e)=>{
    const currentTime = new Date().getTime();
    if(currentTime - (window.lastTapTime || 0) < 300){
      placeModel();
      window.lastTapTime = 0;
    } else { window.lastTapTime = currentTime; }
  });

  animate();
}

function loadModel(name){
  loader.load(MODELS[name], gltf=>{
    modelContainer.add(gltf.scene);
    gltf.scene.traverse((child)=>{
      if(child.isMesh){
        child.castShadow = true;
        child.receiveShadow = true;
      }
    });
    modelContainer.position.set(0,0,0);
    modelContainer.scale.set(1,1,1);
  });
}

async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
    videoElement.srcObject = stream;
    await videoElement.play();
    videoElement.style.display = 'block';
  }catch(err){console.warn('No se pudo activar la cámara', err);}
}

// --- Funciones AR ---
function placeModel(){
  placedOnce = true;
  placementDot.style.display = 'none';
  // Guardar posición inicial en mundo real
  initialWorldPos.copy(modelContainer.position);
}

function animate(){
  requestAnimationFrame(animate);

  if(controls) controls.update();

  if(placedOnce){
    // Ajustar posición para que parezca fijo aunque camines
    // Se puede implementar con cámara/world matrix
    // Para simplificar, aquí mantenemos el offset original
    modelContainer.position.copy(initialWorldPos);
  }

  renderer.render(scene, camera);
}

</script>
</body>
</html>
