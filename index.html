<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Web AR M√≥vil ‚Äì Three.js + C√°mara</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #161616;
      font-family: 'Inter', Arial, sans-serif;
      overscroll-behavior: contain;
    }
    #ar-root {
      position: fixed;
      inset: 0;
      width: 100vw; height: 100vh;
      overflow: hidden;
    }
    #camera-stream {
      position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
      z-index: 1;
      background: #111;
    }
    #three-canvas {
      position: absolute; inset: 0; width: 100%; height: 100%; z-index: 2;
      touch-action: none;
    }
    #ui-top, #ui-bottom {
      position: absolute; left: 0; right: 0; z-index: 3;
      display: flex; align-items: center; justify-content: space-around;
      pointer-events: auto;
      transition: background .2s;
    }
    #ui-top { top: 7px; height: 54px; background: rgba(16, 16, 18, 0.28); }
    #ui-bottom { bottom: 12px; height: 56px; background: rgba(20,20,22, 0.28); flex-wrap: wrap; }
    .btn, .slider {
      border-radius: 9px;
      border: none;
      font-size: 1.06em;
      background: #333a;
      color: #e9e9e9;
      margin: 0 5px;
      min-width: 48px;
      min-height: 36px;
      padding: 8px 18px;
      cursor: pointer;
      outline: none;
      transition: background .2s;
    }
    .btn:active { background: #7cf3cf88; }
    .slider { width: 80px; background: none; }
    #model-picker { display: flex; }
    #placement-dot {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      pointer-events: none;
      width: 34px; height: 34px;
      border-radius: 50%;
      background: rgba(255,255,255,0.11);
      box-shadow: 0 0 20px #0ff9, 0 0 2px #fff;
      border: 2px solid #6cf9fa;
      animation: dot-pulse 1.6s infinite;
    }
    @keyframes dot-pulse {
      0%,100% { box-shadow: 0 0 13px #0ff9, 0 0 2px #fff; }
      40% { box-shadow: 0 0 32px #8cf9ffaa, 0 0 8px #fff; }
      60% { box-shadow: 0 0 8px #0ff9, 0 0 0px #fff; }
    }
    #hint {
      position: absolute;
      top: 8%; left: 50%; transform: translateX(-50%);
      color: #fff; background: rgba(18,18,19,0.6); border-radius: 8px;
      padding: 8px 16px; font-size: 1.1em; z-index: 20;
      pointer-events: none;
    }
    #notif {
      position: absolute;
      bottom: 18%; left: 52%; transform: translateX(-52%);
      background: #1dd9aaee; color: #fff; font-weight: bold;
      border-radius: 8px; padding: 7px 17px; z-index: 20;
      opacity: 0; transition: opacity .7s;
    }
    #notif.active { opacity: 1; }
    #ios-perm {
      position: absolute; left:0; right:0; top:0; bottom:0;
      background: rgba(14,17,21,0.85); display: none; z-index: 12; align-items: center; justify-content: center;
      flex-direction: column; color: #fff;
      font-size: 1.03em;
      gap: 16px;
    }
    #ios-perm button { font-size: 1.08em; background: #0ff9f9; color: #223; border-radius: 14px; border:none; padding: 17px 40px;}
    @media (max-width:600px){
      .slider { width: 67px;}
      #ui-top, #ui-bottom { flex-wrap: wrap; }
    }
    body.light { background: #fff;}
    body.light #ui-top, body.light #ui-bottom { background: rgba(236,236,245,0.23);}
    body.light #hint { color: #275;}
  </style>
</head>
<body>
  <div id="ar-root">
    <video id="camera-stream" autoplay playsinline muted></video>
    <canvas id="three-canvas"></canvas>
    <div id="placement-dot"></div>
    <div id="hint">Apunta al suelo y toca para colocar el modelo</div>
    <div id="notif"></div>
    <div id="ui-top">
      <div id="model-picker">
        <button class="btn" data-model="duck">Duck</button>
        <button class="btn" data-model="helmet">Helmet</button>
        <button class="btn" data-model="boombox">BoomBox</button>
      </div>
      <button class="btn" id="dark-toggle">üåó</button>
    </div>
    <div id="ui-bottom">
      <button class="btn" id="relocate-btn" style="display:none;">Re-ubicar</button>
      <label>Escala
        <input id="scale-slider" type="range" class="slider" min="0.05" max="2" step="0.01" value="1">
      </label>
      <label>Rotaci√≥n
        <input id="rot-slider" type="range" class="slider" min="0" max="360" step="1" value="0">
      </label>
      <button class="btn" id="motion-toggle">Giro ‚ü≥</button>
      <button class="btn" id="ar-toggle">AR ON</button>
    </div>
    <div id="ios-perm" style="display:none;">
      <p>Se requiere permiso de sensores de movimiento.<br>Presiona para activar.</p>
      <button id="ios-btn">Activar sensor</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/controls/DeviceOrientationControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/loaders/GLTFLoader.js"></script>
  <script>
    // --- CONFIGURACI√ìN DE MODELOS GLB ---
    const MODELS = {
      duck:  "https://rawcdn.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb",
      helmet:"https://rawcdn.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/Helmet/glTF-Binary/Helmet.glb",
      boombox:"https://rawcdn.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/BoomBox/glTF-Binary/BoomBox.glb"
    };
    let selectedModelName = null;
    let placedModel = null, modelObj = null, shadowMesh = null;

    // --- C√ÅMARA PASSTHROUGH ---
    const video = document.getElementById('camera-stream');
    async function initCamera(){
      let facingMode = 'environment';
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode, width:{ideal:1920}, height: {ideal:1080} }, audio:false});
        video.srcObject = stream;
      }catch(e){
        alert('No se pudo acceder a la c√°mara: '+e);
      }
      video.onloadedmetadata = () => resizeCanvas();
    }
    // --- THREE.JS: CARGA Y ESCENA ---
    const renderer = new THREE.WebGLRenderer({canvas:document.getElementById('three-canvas'),alpha:true,antialias:true});
    renderer.setClearColor(0x000000,0); // Fondo transparente
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(54, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(0,1.3,2.2);

    // --- LUCES Y PLANO SHADOW ---
    const ambient = new THREE.AmbientLight(0xffffff, 0.63);
    scene.add(ambient);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.1);
    dirLight.position.set(-0.7, 2.5, 0.8);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 512;
    dirLight.shadow.mapSize.height = 512;
    dirLight.shadow.camera.near = 1;
    dirLight.shadow.camera.far = 6;
    dirLight.shadow.camera.left = -2;
    dirLight.shadow.camera.right = 2;
    dirLight.shadow.camera.top = 2;
    dirLight.shadow.camera.bottom = -2;
    scene.add(dirLight);

    // Plano invisible para sombra
    const shadowGeo = new THREE.PlaneGeometry( 0.9, 0.9 );
    const shadowMat = new THREE.ShadowMaterial({ opacity: 0.23 });
    shadowMesh = new THREE.Mesh( shadowGeo, shadowMat );
    shadowMesh.rotation.x = -Math.PI/2;
    shadowMesh.position.y = 0.01;
    shadowMesh.receiveShadow = true;
    scene.add( shadowMesh );

    // --- CARGA DE MODELOS ---
    const loader = new THREE.GLTFLoader();
    function loadModel(modelName){
      showNotif('Cargando modelo...');
      loader.load(MODELS[modelName], (gltf) => {
        if(modelObj) scene.remove(modelObj);
        modelObj = gltf.scene;
        modelObj.traverse((n) => {
          if(n.isMesh){
            n.castShadow = true;
            n.receiveShadow = true;
          }
        });
        modelObj.visible = false;
        modelObj.position.set(0,0,0);
        modelObj.scale.set(1,1,1);
        scene.add(modelObj);
        shadowMesh.visible = false;
        hideNotif();
      }, undefined, err => {
        showNotif('Error cargando modelo');
      });
    }

    // --- INTERFAZ DE USUARIO ---
    function showNotif(text){
      const el = document.getElementById("notif");
      el.textContent = text;
      el.classList.add("active");
      setTimeout(()=>el.classList.remove("active"),1900);
    }
    function setHint(text){ document.getElementById("hint").textContent = text; }
    function showDot(show=true){ document.getElementById("placement-dot").style.display = show ? 'block' : 'none'; }
    function showRelocate(show=true){ document.getElementById("relocate-btn").style.display = show ? '' : 'none'; }

    // --- MOTION + ORIENTACI√ìN ---
    let devOrientActive = false;
    let deviceControls = null;
    function initMotion(){
      if(!deviceControls) deviceControls = new THREE.DeviceOrientationControls(camera);
      devOrientActive = true;
      setHint('Modo AR: mueve el tel√©fono para ver');
      showNotif('Motion tracking activado');
    }
    function stopMotion(){
      devOrientActive = false;
      setHint('Desactiva motion tracking');
      showNotif('Motion tracking desactivado');
    }

    // --- COLOCACI√ìN Y TRACKING AR ---
    let arMode = true, modelPlaced = false;
    let placedPos = new THREE.Vector3(0,0,0), placedRotY = 0, placedScale = 1;
    function placeModel(){
      if(!modelObj || !selectedModelName) return;
      modelObj.position.copy(placedPos);
      modelObj.visible = true;
      shadowMesh.position.set(placedPos.x,0.01,placedPos.z);
      shadowMesh.visible = true;
      modelPlaced = true;
      setHint('Modelo colocado. Usa controles para mover, escalar y rotar');
      showDot(false);
      showRelocate(true);
      showNotif('Modelo colocado');
    }
    function relocateModel(){
      modelPlaced = false;
      modelObj.visible = false;
      shadowMesh.visible = false;
      showDot(true);
      showRelocate(false);
      setHint('Apunta y toca para colocar otra vez');
    }

    // --- MANEJO DE TOQUES/GESTOS ---
    let lastTouchDist = null;
    function onTouchStart(e){
      if(e.touches && e.touches.length === 2){ // Pinch  
        const d = Math.hypot(
          e.touches[0].clientX-e.touches[1].clientX,
          e.touches[0].clientY-e.touches[1].clientY
        );
        lastTouchDist = d;
      }
    }
    function onTouchMove(e){
      if(e.touches && e.touches.length === 2 && modelObj && modelPlaced){ // Escalar
        const d =
           Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
        const scaleDelta = (d - lastTouchDist) * 0.005;
        placedScale = Math.max(.05, Math.min(2, placedScale + scaleDelta));
        document.getElementById("scale-slider").value = placedScale;
        lastTouchDist = d;
      }
    }
    let dragging=false, lastDragX=0;
    function onPointerDown(e){
      if(modelObj && modelPlaced){
        dragging = true;
        lastDragX = e.clientX;
      }
    }
    function onPointerMove(e){
      if(modelObj && modelPlaced && dragging){
        let deltaX = e.clientX - lastDragX;
        placedRotY = (placedRotY + deltaX*0.6) % 360;
        document.getElementById("rot-slider").value = placedRotY;
        lastDragX = e.clientX;
      }
    }
    function onPointerUp(){ dragging = false; }

    // --- CONTROLES DE UI ---
    document.querySelectorAll('#model-picker .btn').forEach(btn=>{
      btn.onclick = e=>{
        selectedModelName = btn.dataset.model;
        loadModel(selectedModelName);
        setHint('Elige ubicaci√≥n y toca para colocar');
        modelPlaced=false; showDot(true); showRelocate(false);
        if(modelObj) modelObj.visible = false;
        if(shadowMesh) shadowMesh.visible = false;
      }
    });
    document.getElementById('relocate-btn').onclick = relocateModel;

    document.getElementById('motion-toggle').onclick = ()=>{
      if(!devOrientActive) initMotion(); else stopMotion();
    };
    document.getElementById('ar-toggle').onclick = ()=>{
      arMode = !arMode;
      document.getElementById('ar-toggle').textContent = arMode ? 'AR ON' : 'AR OFF';
      setHint(arMode ? 'Modo AR activo' : 'Colocaci√≥n manual activa');
      showNotif(arMode ? 'AR activado' : 'AR desactivado');
    }
    document.getElementById("scale-slider").oninput = (e)=>{
      placedScale = parseFloat(e.target.value);
    }
    document.getElementById("rot-slider").oninput = (e)=>{
      placedRotY = parseFloat(e.target.value);
    }
    document.getElementById("dark-toggle").onclick = ()=>{
      document.body.classList.toggle('light');
    }

    // --- PERMISOS PARA SENSORES EN iOS ---
    function checkIOSMotion(){
      if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
        document.getElementById("ios-perm").style.display = 'flex';
        document.getElementById("ios-btn").onclick = ()=>{
          DeviceMotionEvent.requestPermission().then(p=>{
            document.getElementById("ios-perm").style.display = 'none';
          });
        }
      }
    }

    // --- CANVAS FULLSCREEN + ASPECT ---
    function resizeCanvas(){
      const w=window.innerWidth, h=window.innerHeight;
      renderer.setSize(w,h,false);
      camera.aspect=w/h; camera.updateProjectionMatrix();
    }
    window.onresize = resizeCanvas;

    // --- EVENTOS PRINCIPALES ---
    document.getElementById("three-canvas").addEventListener('touchstart',onTouchStart,{passive:true});
    document.getElementById("three-canvas").addEventListener('touchmove',onTouchMove,{passive:true});
    document.getElementById("three-canvas").addEventListener('pointerdown',onPointerDown);
    document.getElementById("three-canvas").addEventListener('pointermove',onPointerMove);
    document.getElementById("three-canvas").addEventListener('pointerup',onPointerUp);
    document.getElementById("three-canvas").addEventListener('touchend', ()=>{
      lastTouchDist=null; dragging=false;
    });

    document.getElementById("three-canvas").addEventListener('click', ()=>{
      if(!modelPlaced && selectedModelName && modelObj){
        placeModel();
      }
    });

    // --- LOOP PRINCIPAL AR ---
    function animate(){
      requestAnimationFrame(animate);
      // Renderizar modelo colocado y shadow
      if(modelObj){
        // Si est√° colocado, siempre en la posici√≥n "fixed" virtual (simula AR sin SLAM)
        if(modelPlaced){
          modelObj.visible = true;
          modelObj.position.copy(placedPos);
          modelObj.rotation.y = placedRotY* Math.PI/180;
          modelObj.scale.setScalar(placedScale);
          shadowMesh.position.set(placedPos.x, 0.01, placedPos.z);
          shadowMesh.visible = true;
        }
      }
      // Simulaci√≥n de tracking AR:
      if(arMode && !modelPlaced){
        // Mientras no se coloque, mantener ret√≠culo en pantalla.
        // Para el demo, se mantiene en 0,0,0 pero puedes a√±adir raycasting visual real
        placedPos.set(0, 0, -0.95);
      }
      // Device motion tracking
      if(devOrientActive && deviceControls){
        deviceControls.update();
      }
      renderer.render(scene,camera);
    }

    // --- INICIO ---
    initCamera();
    checkIOSMotion();
    resizeCanvas();
    animate();

    // --- INSTRUCCIONES USO ---
    // 1. Selecciona el modelo GLB desde el men√∫ superior.
    // 2. Apunta el m√≥vil hacia el suelo/mesa, toca la pantalla para colocar el modelo 3D.
    // 3. Usa los sliders o gestos t√°ctiles para ajustar escala y rotaci√≥n.
    // 4. Alterna entre AR (tracking motion del dispositivo) y colocaci√≥n manual.
    // 5. Pulsa 'Re-ubicar' para recolocar el modelo.
    // 6. Toggle modo oscuro con el bot√≥n üåó.
    // 7. Pantalla y gestos optimizados para m√≥viles.
  </script>
</body>
</html>
