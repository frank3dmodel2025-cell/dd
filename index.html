<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor 3D Minimalista con AR Ilusi√≥n</title>
    
    <!-- Scripts de Tailwind, Three.js y OrbitControls -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles and custom scrollbar for minimalist theme */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f3ed; 
            color: #3b4233;
            overflow: hidden;
            touch-action: none; /* Prevenir el comportamiento de arrastre nativo del navegador */
        }
        
        /* Glassmorphism para paneles */
        .glass-panel-minimal {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.08);
            border-radius: 2rem;
        }
        
        /* Custom scrollbar */
        .glass-panel-minimal::-webkit-scrollbar { width: 8px; }
        .glass-panel-minimal::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
        .glass-panel-minimal::-webkit-scrollbar-thumb { background: #9fbe89; border-radius: 10px; }
        .glass-panel-minimal::-webkit-scrollbar-thumb:hover { background: #8aa97a; }

        /* Botones con estilo minimalista */
        .minimal-btn {
            background-color: #9fbe89;
            color: #ffffff;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            text-align: center;
        }
        .minimal-btn:hover {
            background-color: #8aa97a;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .minimal-btn:active {
            background-color: #769469;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
        }
        .minimal-btn:disabled {
            background-color: #c0c0c0; /* Un gris m√°s claro */
            color: #808080; /* Texto gris */
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        /* Estilo de los items del selector de modelo (Modal) */
        .model-selector-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 1.5rem;
            border: 2px solid transparent;
            border-radius: 1.5rem;
            transition: all 0.2s ease-in-out;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .model-selector-item:hover {
            border-color: #9fbe89;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .model-selector-item.active {
            background-color: #9fbe89;
            color: #ffffff;
            border-color: #769469;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            transform: scale(1.02);
        }
        .model-selector-item.active span {
            color: #ffffff;
        }

        /* CLASES DE VISIBILIDAD PARA EL PANEL DE CONTROL */
        #control-panel {
            /* Estado Inicial: Oculto a la izquierda */
            transform: translateX(calc(-100% - 2rem)); 
            transition: transform 0.3s ease-in-out;
            z-index: 20; 
        }

        #control-panel.is-visible {
            /* Estado Visible: Deslizado a la posici√≥n inicial */
            transform: translateX(0);
            z-index: 30; /* Asegurar que est√© sobre el canvas */
        }
        
        /* Ajustes de posici√≥n de los botones en m√≥vil para evitar que se solapen con el panel */
        @media (max-width: 768px) {
            #control-panel {
                width: calc(100vw - 2rem); 
                height: 75vh;
                top: 1rem;
                left: 1rem;
                right: 1rem;
            }
            
            #menu-toggle-btn {
                z-index: 50;
            }
            
            #open-model-selector-btn {
                z-index: 50;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'light-bg': '#f7f3ed',
                        'panel-bg': 'rgba(255, 255, 255, 0.7)',
                        'accent-color': '#9fbe89',
                        'text-dark-soft': '#3b4233',
                        'text-light-soft': '#5c6c4e',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-light-bg text-text-dark-soft">

    <!-- Contenedor Principal -->
    <div id="app-container" class="w-screen h-screen relative">
        
        <!-- Contenedor del Canvas 3D (Ocupa todo el fondo) -->
        <div id="three-canvas-container" class="w-full h-full"></div>

        <!-- Caja de Alerta Minimalista -->
        <div id="alert-box" class="glass-panel-minimal fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-4 z-50 transition-opacity duration-300 pointer-events-none opacity-0"
            role="alert">
            <p id="alert-message" class="text-text-dark-soft font-medium"></p>
        </div>

        <!-- Bot√≥n de Men√∫ (Abre Controles) -->
        <button id="menu-toggle-btn"
            class="fixed top-4 left-4 p-3 glass-panel-minimal shadow-lg hover:shadow-xl transition duration-200 z-50 rounded-full"
            onclick="togglePanelVisibility()">
            <!-- Icono de Men√∫ -->
            <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-text-dark-soft">
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
            <!-- Icono de Cierre (X) -->
            <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-text-dark-soft hidden">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        
        <!-- Bot√≥n de Selecci√≥n de Modelo (Abre Modal) -->
        <button id="open-model-selector-btn"
            class="fixed top-4 right-4 p-3 glass-panel-minimal shadow-lg hover:shadow-xl transition duration-200 z-50 rounded-full flex items-center space-x-2"
            onclick="toggleModelSelector(true)">
            <!-- Icono de Objeto 3D -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-text-dark-soft">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <path d="M7 17l10-10"></path>
                <path d="M10 17l4-4"></path>
            </svg>
            <span class="hidden md:inline text-sm font-medium">Modelos</span>
        </button>


        <!-- Panel de Control (Siempre oculto al inicio, se desliza con el bot√≥n de men√∫) -->
        <div id="control-panel"
             class="glass-panel-minimal fixed top-4 left-4 
                    w-72 p-6 h-[calc(100vh-2rem)]
                    transition-transform duration-300 overflow-y-auto">
            
            <h2 class="text-2xl font-semibold mb-6 text-accent-color">Controles 3D</h2>

            <!-- Modelo Actual -->
            <div class="mb-6 pb-4 border-b border-gray-200">
                <p class="text-sm text-text-light-soft mb-1">Modelo Actual:</p>
                <p id="current-model-name" class="text-xl font-medium">Duck</p>
            </div>

            <!-- Navegaci√≥n -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3 border-b border-gray-200 pb-1">Navegaci√≥n</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button class="minimal-btn" onclick="zoomCamera(1.1)">
                        Zoom +
                    </button>
                    <button class="minimal-btn" onclick="zoomCamera(0.9)">
                        Zoom -
                    </button>
                </div>
            </div>

            <!-- Escala -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3 border-b border-gray-200 pb-1">Escala</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button class="minimal-btn" onclick="scaleModel(1.2)">
                        Escala +
                    </button>
                    <button class="minimal-btn" onclick="scaleModel(0.8)">
                        Escala -
                    </button>
                </div>
            </div>

            <!-- Modos -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3 border-b border-gray-200 pb-1">Modos</h3>
                <div class="space-y-3">
                    <button id="toggle-rotate-btn" class="minimal-btn w-full" onclick="toggleAutoRotate()">
                        Rotaci√≥n Autom√°tica: <span id="auto-rotate-status">OFF</span>
                    </button>
                    <button id="toggle-lock-btn" class="minimal-btn w-full" onclick="toggleLockModel()">
                        Mover Modelo: <span id="lock-status">OFF (Rotar)</span>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 italic">Si est√° en OFF (Rotar), usa el dedo para rotar. Si est√° en ON (Mover), usa el dedo para moverlo por la pantalla.</p>
            </div>

            <!-- Simulaci√≥n AR -->
            <div class="mb-6">
                <h3 class="text-lg font-medium mb-3 border-b border-gray-200 pb-1">Simulaci√≥n AR</h3>
                <button id="toggle-placement-btn" class="minimal-btn w-full bg-orange-400 hover:bg-orange-500" onclick="togglePlacementMode()">
                    Modo Pared (AR): <span id="placement-status">OFF</span>
                </button>
                <p class="text-xs text-gray-500 mt-2 italic">Requiere permiso de la c√°mara y sensores.</p>
            </div>
            
            <!-- Controles de Posici√≥n (AR) -->
            <div id="placement-controls" class="space-y-3 pt-4 border-t border-gray-200 hidden">
                <h3 class="text-lg font-medium text-orange-500">Ajuste de Posici√≥n (AR)</h3>
                <p class="text-sm text-text-light-soft">Mueve el modelo para alinearlo.</p>
                
                <!-- Movimiento X -->
                <div class="flex flex-col">
                    <span class="text-sm mb-1 text-text-light-soft">Movimiento Horizontal (X)</span>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="minimal-btn bg-orange-400/80 hover:bg-orange-500" onclick="moveModel('x', -0.1)">
                            ‚Üê Izquierda
                        </button>
                        <button class="minimal-btn bg-orange-400/80 hover:bg-orange-500" onclick="moveModel('x', 0.1)">
                            Derecha ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Movimiento Y -->
                <div class="flex flex-col">
                    <span class="text-sm mb-1 text-text-light-soft">Movimiento Vertical (Y)</span>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="minimal-btn bg-orange-400/80 hover:bg-orange-500" onclick="moveModel('y', 0.1)">
                            ‚Üë Arriba
                        </button>
                        <button class="minimal-btn bg-orange-400/80 hover:bg-orange-500" onclick="moveModel('y', -0.1)">
                            Abajo ‚Üì
                        </button>
                    </div>
                </div>
                
                <!-- Rotaci√≥n Z -->
                <div class="flex flex-col">
                    <span class="text-sm mb-1 text-text-light-soft">Rotaci√≥n (Inclinaci√≥n Z)</span>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="minimal-btn bg-purple-400/80 hover:bg-purple-500" onclick="rotateModel('z', 0.05)">
                            Giro Izq.
                        </button>
                        <button class="minimal-btn bg-purple-400/80 hover:bg-purple-500" onclick="rotateModel('z', -0.05)">
                            Giro Der.
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-8">
                <p class="text-sm text-gray-400">Visor 3D Propulsado por Three.js</p>
            </div>

        </div>

        <!-- Modal de Selecci√≥n de Modelos (Reemplaza el Carrusel) -->
        <div id="model-selector-modal"
             class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-40 
                    flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
            
            <!-- Contenedor del Modal -->
            <div class="glass-panel-minimal p-6 w-11/12 max-w-lg md:w-3/4 md:max-w-xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6 border-b pb-2 border-gray-200">
                    <h3 class="text-2xl font-bold text-accent-color">Seleccionar Modelo 3D</h3>
                    <button class="p-2 text-text-dark-soft hover:text-red-500 transition" onclick="toggleModelSelector(false)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Opciones de Modelo (Grid) -->
                <div class="grid grid-cols-2 gap-4">
                    <button class="model-selector-item active" data-model="Duck" onclick="selectModel('Duck')">
                        <span class="text-5xl mb-2">ü¶Ü</span>
                        <span class="font-semibold text-text-dark-soft">Duck (Pato)</span>
                    </button>
                    <button class="model-selector-item" data-model="Helmet" onclick="selectModel('Helmet')">
                        <span class="text-5xl mb-2">üõ°Ô∏è</span>
                        <span class="font-semibold text-text-dark-soft">Helmet (Casco)</span>
                    </button>
                    <button class="model-selector-item" data-model="BoomBox" onclick="selectModel('BoomBox')">
                        <span class="text-5xl mb-2">üìª</span>
                        <span class="font-semibold text-text-dark-soft">BoomBox (Bocina)</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Variables de Three.js y Configuraci√≥n de Posici√≥n ---
        let scene, camera, renderer, controls;
        let loader, currentModel = null;
        let video = null; 
        let videoTexture = null;
        
        let isPlacementModeActive = false; 
        let isPanelVisible = false;

        // Variables para la interacci√≥n directa de arrastre (Touch/Mouse)
        let isDraggingModel = false;
        let lastClientX, lastClientY;

        // Global variable for the device orientation permission status (for iOS 13+)
        let deviceOrientationPermissionGranted = false;
        // Global variable for the device orientation event handler reference
        let deviceOrientationEventHandler = null;


        // Rutas de los modelos
        const MODEL_PATHS = {
            'Duck': 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
            'Helmet': 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/DamagedHelmet/glTF/DamagedHelmet.gltf',
            'BoomBox': 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/BoomBox/glTF/BoomBox.gltf'
        };

        // Constantes para posiciones de C√°mara y Target
        const DEFAULT_CAMERA_POS = new THREE.Vector3(0, 1.5, 4);
        const DEFAULT_TARGET_POS = new THREE.Vector3(0, 0, 0);

        // Configuraci√≥n para el "Modo Pared" (Ilusi√≥n AR)
        // La c√°mara debe estar cerca de 0,0,0 para imitar el punto de vista del usuario
        // El modelo debe estar m√°s lejos en Z para aparecer "en el fondo" del v√≠deo.
        const PLACEMENT_CAMERA_POS = new THREE.Vector3(0, 1.3, 0.5); 
        const PLACEMENT_TARGET_POS = new THREE.Vector3(0, 1.3, -2.5); // El target no es tan relevante cuando el giroscopio controla la rotaci√≥n
        const PLACEMENT_MODEL_OFFSET = new THREE.Vector3(0, 0, -2.5); // Posici√≥n inicial del modelo en modo AR


        // --- Inicializaci√≥n de Three.js ---
        function initThree() {
            // 1. Configuraci√≥n de la Escena, C√°mara y Renderizador
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.copy(DEFAULT_CAMERA_POS);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            const canvasContainer = document.getElementById('three-canvas-container');
            canvasContainer.appendChild(renderer.domElement);

            // 2. Iluminaci√≥n
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            // 3. Controles de √ìrbita
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.target.copy(DEFAULT_TARGET_POS);

            // 4. Loader
            loader = new THREE.GLTFLoader();

            // 5. Manejo de Eventos (Redimensionamiento y Arrastre)
            window.addEventListener('resize', onWindowResize, false);
            
            // Agregar listeners de arrastre (pointer events unificados para touch/mouse)
            renderer.domElement.addEventListener('pointerdown', onPointerDown, false);
            renderer.domElement.addEventListener('pointermove', onPointerMove, false);
            renderer.domElement.addEventListener('pointerup', onPointerUp, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Manejo de la Orientaci√≥n del Dispositivo (Giroscopio) ---
        function handleDeviceOrientation(event) {
            if (!isPlacementModeActive) return; // Solo aplicar si el modo AR est√° activo

            // Los valores alpha, beta, gamma representan rotaciones en el espacio
            // y pueden requerir ajustes (orden Euler, signos) dependiendo del dispositivo/navegador.
            // Este es un intento com√∫n para alinear el dispositivo con la c√°mara de Three.js.
            // Alpha: Rotaci√≥n alrededor del eje Z (yaw, br√∫jula)
            // Beta: Rotaci√≥n alrededor del eje X (pitch, inclinaci√≥n adelante/atr√°s)
            // Gamma: Rotaci√≥n alrededor del eje Y (roll, inclinaci√≥n izquierda/derecha)

            const alpha = event.alpha ? THREE.MathUtils.degToRad(event.alpha) : 0;
            const beta = event.beta ? THREE.MathUtils.degToRad(event.beta) : 0;
            const gamma = event.gamma ? THREE.MathUtils.degToRad(event.gamma) : 0;

            const euler = new THREE.Euler();
            // El orden 'YXZ' es a menudo una buena base. -gamma es com√∫n para compensar el sistema de coordenadas.
            euler.set(beta, alpha, -gamma, 'YXZ'); 
            
            camera.quaternion.setFromEuler(euler);
        }

        // --- Bucle de Animaci√≥n ---
        function animate() {
            requestAnimationFrame(animate);
            if (!isPlacementModeActive) { // Solo actualiza OrbitControls si no estamos en modo AR
                controls.update(); 
            }
            if (videoTexture) videoTexture.needsUpdate = true;
            renderer.render(scene, camera);
        }
        
        // --- L√≥gica de Arrastre Directo (Move Model) ---

        /** Calcula la escala de p√≠xeles a unidades mundiales en la posici√≥n actual del modelo. */
        function screenToWorldScale() {
            if (!currentModel) return { pixelToWorldX: 0, pixelToWorldY: 0 };
            
            // Distancia del modelo a la c√°mara
            const distance = camera.position.distanceTo(currentModel.position);
            
            // Altura y ancho del mundo visibles en el plano del modelo (su Z)
            const vFOV = camera.fov * Math.PI / 180;
            const worldHeight = 2 * Math.tan(vFOV / 2) * distance;
            const worldWidth = worldHeight * camera.aspect;

            // Ratio P√≠xel a Unidad Mundial
            const pixelToWorldX = worldWidth / window.innerWidth;
            const pixelToWorldY = worldHeight / window.innerHeight;
            
            return { pixelToWorldX, pixelToWorldY };
        }

        function onPointerDown(event) {
            // Permitir arrastre del modelo S√ìLO si OrbitControls est√° DESHABILITADO 
            // y no estamos en modo AR.
            if (!controls.enabled && !isPlacementModeActive && currentModel) {
                isDraggingModel = true;
                lastClientX = event.clientX;
                lastClientY = event.clientY;
                // Prevenir que el navegador maneje el evento (ej. scroll)
                renderer.domElement.setPointerCapture(event.pointerId); 
            }
        }

        function onPointerMove(event) {
            if (!isDraggingModel) return;

            const dx = event.clientX - lastClientX;
            const dy = event.clientY - lastClientY;

            const { pixelToWorldX, pixelToWorldY } = screenToWorldScale();
            
            // Mover el modelo: Invertir Y porque en la pantalla Y+ es abajo, pero en 3D Y+ es arriba
            currentModel.position.x += dx * pixelToWorldX;
            currentModel.position.y -= dy * pixelToWorldY; // Invertir Y

            lastClientX = event.clientX;
            lastClientY = event.clientY;
        }

        function onPointerUp(event) {
            if (isDraggingModel) {
                isDraggingModel = false;
                renderer.domElement.releasePointerCapture(event.pointerId);
                alertMessage('Modelo movido directamente.');
            }
        }


        // --- Funcionalidad de Carga y Selecci√≥n de Modelos ---
        function loadModel(url, modelName) {
            alertMessage(`Cargando modelo: ${modelName}...`);

            if (currentModel) {
                scene.remove(currentModel);
                currentModel = null;
            }

            loader.load(
                url,
                (gltf) => {
                    currentModel = gltf.scene;
                    
                    // Centrar y escalar el modelo para que encaje
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const size = box.getSize(new THREE.Vector3()).length();
                    const center = box.getCenter(new THREE.Vector3());
                    
                    currentModel.position.sub(center); 

                    const scaleFactor = 4 / size; 
                    currentModel.scale.set(scaleFactor, scaleFactor, scaleFactor);
                    
                    scene.add(currentModel);
                    
                    if (isPlacementModeActive) {
                        currentModel.position.copy(PLACEMENT_MODEL_OFFSET);
                        currentModel.rotation.set(0, 0, 0); // Reset rotation in AR mode initially
                    } else {
                        currentModel.position.set(0, 0, 0);
                        currentModel.rotation.set(0, 0, 0); // Reset rotation in normal mode
                    }

                    alertMessage(`Modelo "${modelName}" cargado con √©xito.`);
                },
                (xhr) => {}, // Progreso
                (error) => {
                    console.error('Error cargando modelo:', error);
                    alertMessage(`ERROR: No se pudo cargar el modelo "${modelName}".`, 'error');
                }
            );
        }

        function selectModel(modelName) {
            const url = MODEL_PATHS[modelName];
            if (url) {
                loadModel(url, modelName);
                document.getElementById('current-model-name').textContent = modelName;
                
                // 1. Actualizar estilo del selector (Modal)
                document.querySelectorAll('.model-selector-item').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-model="${modelName}"]`).classList.add('active');
                
                // 2. Ocultar el modal despu√©s de la selecci√≥n
                toggleModelSelector(false);

            } else {
                alertMessage('Modelo no encontrado.', 'error');
            }
        }


        // --- Funcionalidad de Controles UI ---
        
        // 1. Alternar Visibilidad del Panel de Controles
        function togglePanelVisibility() {
            const panel = document.getElementById('control-panel');
            const menuIcon = document.getElementById('menu-icon');
            const closeIcon = document.getElementById('close-icon');
            
            isPanelVisible = !isPanelVisible;

            if (isPanelVisible) {
                // Mostrar panel
                panel.classList.add('is-visible');
                menuIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
                // Deshabilitar OrbitControls mientras el panel est√° visible
                controls.enabled = false; 
            } else {
                // Ocultar panel
                panel.classList.remove('is-visible');
                menuIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
                // Restaurar OrbitControls si no estamos en Modo Mover (el estado es Rotar)
                // Y NO estamos en modo AR
                if (!document.getElementById('lock-status').textContent.includes('Mover') && !isPlacementModeActive) {
                    controls.enabled = true;
                }
            }
        }
        
        // 2. Alternar Visibilidad del Modal de Selecci√≥n
        function toggleModelSelector(show) {
            const modal = document.getElementById('model-selector-modal');
            if (show) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.remove('opacity-100', 'pointer-events-auto');
            }
        }


        // 3. Zoom de C√°mara
        function zoomCamera(factor) {
            if (isPlacementModeActive) {
                alertMessage('Zoom de c√°mara deshabilitado en Modo Pared. Ajusta el modelo directamente.', 'warning');
                return;
            }
            if (!controls) return;
            
            const currentDistance = camera.position.distanceTo(controls.target);
            const newDistance = currentDistance * factor;
            
            if (newDistance > 0.5 && newDistance < 100) {
                const direction = new THREE.Vector3().subVectors(camera.position, controls.target).normalize();
                camera.position.copy(controls.target).add(direction.multiplyScalar(newDistance));
                controls.update();
                alertMessage(factor > 1 ? 'Acercando Zoom' : 'Alejando Zoom');
            } else {
                alertMessage('L√≠mite de Zoom alcanzado.', 'info');
            }
        }

        // 4. Escala del Modelo
        function scaleModel(factor) {
            if (!currentModel) {
                alertMessage('Cargue un modelo primero.', 'warning');
                return;
            }
            currentModel.scale.multiplyScalar(factor);
            alertMessage(factor > 1 ? 'Aumentando Escala' : 'Reduciendo Escala');
        }

        // 5. Rotaci√≥n Autom√°tica
        function toggleAutoRotate() {
            if (isPlacementModeActive) {
                alertMessage('Rotaci√≥n autom√°tica deshabilitada en Modo Pared.', 'warning');
                return;
            }
            controls.autoRotate = !controls.autoRotate;
            const statusText = controls.autoRotate ? 'ON' : 'OFF';
            document.getElementById('auto-rotate-status').textContent = statusText;
            alertMessage(`Rotaci√≥n Autom√°tica: ${statusText}`);
        }

        // 6. Bloquear/Desbloquear Controles de √ìrbita (Permite Arrastre Directo si est√° "Bloqueado")
        function toggleLockModel() {
            // Si el modo pared est√° activo, no se puede cambiar el bloqueo
            if (isPlacementModeActive) {
                alertMessage('El control de √≥rbita est√° bloqueado en Modo Pared.', 'warning');
                return;
            }
            
            controls.enabled = !controls.enabled;
            // Estado "ON" (Mover) significa que controls.enabled es FALSE, permitiendo el arrastre directo.
            const statusText = controls.enabled ? 'OFF (Rotar)' : 'ON (Mover)';
            document.getElementById('lock-status').textContent = statusText;
            alertMessage(`Modo Mover/Rotar: ${controls.enabled ? 'Rotar Activado' : 'Mover Activado'}`);
        }
        
        // 7. Controles de Movimiento Manual (solo para Modo AR)
        function moveModel(axis, distance) {
            if (!currentModel || !isPlacementModeActive) {
                alertMessage('Active el Modo Pared primero.', 'warning');
                return;
            }
            currentModel.position[axis] += distance;
            alertMessage(`Moviendo en ${axis.toUpperCase()} por ${distance > 0 ? '+' : ''}${distance.toFixed(1)}`);
        }
        function rotateModel(axis, angle) {
            if (!currentModel || !isPlacementModeActive) {
                alertMessage('Active el Modo Pared primero.', 'warning');
                return;
            }
            currentModel.rotation[axis] += angle;
            alertMessage(`Rotando en ${axis.toUpperCase()} por ${angle > 0 ? '+' : ''}${angle.toFixed(2)}`);
        }
        
        // 8. Modo Pared (Simulaci√≥n AR)
        async function togglePlacementMode() {
            const btn = document.getElementById('toggle-placement-btn');
            const status = document.getElementById('placement-status');
            const placementControls = document.getElementById('placement-controls');
            const lockBtn = document.getElementById('toggle-lock-btn');
            const autoRotateBtn = document.getElementById('toggle-rotate-btn');

            if (isPlacementModeActive) {
                // --- Desactivar Modo Colocaci√≥n ---
                isPlacementModeActive = false;
                
                // Detener Video/C√°mara
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                video = null;
                videoTexture = null;

                // Quitar listener de deviceorientation
                if (deviceOrientationEventHandler) {
                    window.removeEventListener('deviceorientation', deviceOrientationEventHandler, true);
                    deviceOrientationEventHandler = null; // Limpiar la referencia
                }

                // Restaurar Escena
                scene.background = new THREE.Color(0xf7f3ed); 
                
                // Restaurar C√°mara, Controles y Modelo
                // Restaurar el estado de OrbitControls seg√∫n el √∫ltimo "lock-status" (si no es "Mover")
                const lockStatus = document.getElementById('lock-status').textContent;
                controls.enabled = lockStatus.includes('Rotar');
                controls.autoRotate = false; // Asegurarse de que la rotaci√≥n autom√°tica est√© desactivada
                document.getElementById('auto-rotate-status').textContent = 'OFF';
                
                lockBtn.disabled = false; // Habilitar el toggle de Mover/Rotar
                autoRotateBtn.disabled = false; // Habilitar el toggle de rotaci√≥n autom√°tica
                
                camera.position.copy(DEFAULT_CAMERA_POS);
                controls.target.copy(DEFAULT_TARGET_POS);
                camera.rotation.set(0, 0, 0); // Resetear la rotaci√≥n de la c√°mara (para borrar la del giroscopio)
                camera.quaternion.set(0, 0, 0, 1); // Resetear el cuaterni√≥n tambi√©n
                controls.update(); // Actualizar controles para aplicar el reseteo

                if (currentModel) {
                    currentModel.position.set(0, 0, 0);
                    currentModel.rotation.set(0, 0, 0); // Resetear rotaci√≥n del modelo
                }
                
                // Actualizar UI
                status.textContent = 'OFF';
                btn.classList.remove('bg-green-600', 'hover:bg-green-500'); 
                btn.classList.add('bg-orange-400', 'hover:bg-orange-500');
                placementControls.classList.add('hidden');
                
                alertMessage('Modo Pared Desactivado.');

            } else {
                // --- Activar Modo Colocaci√≥n ---

                // 1. Solicitar permiso de deviceorientation si es necesario (para iOS 13+)
                if (typeof DeviceOrientationEvent.requestPermission === 'function' && !deviceOrientationPermissionGranted) {
                    try {
                        const permissionState = await DeviceOrientationEvent.requestPermission();
                        if (permissionState === 'granted') {
                            deviceOrientationPermissionGranted = true;
                            alertMessage('Permiso de orientaci√≥n del dispositivo concedido.', 'success');
                        } else {
                            alertMessage('Permiso de orientaci√≥n del dispositivo denegado.', 'error');
                            return; // No activar el modo AR si no hay permiso de giroscopio
                        }
                    } catch (err) {
                        console.error('Error al solicitar permiso de Device Orientation:', err);
                        alertMessage('ERROR: No se pudo solicitar permiso de orientaci√≥n del dispositivo. Aseg√∫rate de estar en un contexto seguro (HTTPS).', 'error');
                        return;
                    }
                }

                // 2. Acceder a la c√°mara
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    
                    video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    
                    videoTexture = new THREE.VideoTexture(video);
                    
                    // Configurar Escena para AR Illusion: el fondo es el v√≠deo de la c√°mara
                    scene.background = videoTexture;
                    
                    // Configurar C√°mara, Controles y Modelo para el modo AR
                    controls.enabled = false; // Forzar el bloqueo del control de √≥rbita
                    controls.autoRotate = false; // Desactivar rotaci√≥n autom√°tica
                    document.getElementById('auto-rotate-status').textContent = 'OFF'; // Actualizar UI
                    lockBtn.disabled = true; // Deshabilitar el toggle de Mover/Rotar
                    autoRotateBtn.disabled = true; // Deshabilitar el toggle de rotaci√≥n autom√°tica
                    
                    if (currentModel) {
                        currentModel.position.copy(PLACEMENT_MODEL_OFFSET);
                        currentModel.rotation.set(0, 0, 0); // Reset model rotation in AR mode initially
                    }
                    camera.position.copy(PLACEMENT_CAMERA_POS);
                    controls.target.copy(PLACEMENT_TARGET_POS); // El target sigue la posici√≥n del modelo, aunque la orientaci√≥n sea del giroscopio
                    controls.update(); // Actualizar controles para aplicar la nueva posici√≥n

                    // 3. A√±adir listener de deviceorientation
                    if (!deviceOrientationEventHandler) { // Asegurarse de que el listener solo se a√±ada una vez
                        deviceOrientationEventHandler = handleDeviceOrientation;
                        window.addEventListener('deviceorientation', deviceOrientationEventHandler, true);
                    }

                    // Actualizar UI
                    isPlacementModeActive = true;
                    status.textContent = 'ON';
                    btn.classList.remove('bg-orange-400', 'hover:bg-orange-500'); 
                    btn.classList.add('bg-green-600', 'hover:bg-green-500');
                    placementControls.classList.remove('hidden'); 
                    alertMessage('Modo Pared Activado (C√°mara y Sensores en uso).', 'success');

                } catch (err) {
                    console.error('Error al acceder a la c√°mara o sensores:', err);
                    alertMessage('ERROR: No se pudo acceder a la c√°mara o permisos denegados. Aseg√∫rate de permitir el acceso a la c√°mara.', 'error');
                }
            }
        }


        // 9. Sistema de Alerta Personalizada
        let alertTimeout = null;
        function alertMessage(message, type = 'info') {
            const alertBox = document.getElementById('alert-box');
            const alertMsg = document.getElementById('alert-message');

            if (alertTimeout) {
                clearTimeout(alertTimeout);
            }

            // Reset base classes, then add glass-panel-minimal
            alertBox.className = 'glass-panel-minimal fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-4 z-50 transition-opacity duration-300 pointer-events-none opacity-0';
            
            // L√≥gica de color de alerta...
            const colors = {
                success: { text: 'text-green-600', icon: '‚úì' },
                error: { text: 'text-red-600', icon: '‚úó' },
                warning: { text: 'text-yellow-600', icon: '!' },
                info: { text: 'text-gray-600', icon: 'i' }
            };
            const style = colors[type] || colors.info;

            // Aplica el color del texto a todo el mensaje
            alertMsg.innerHTML = `<span class="${style.text} mr-2">${style.icon}</span> <span class="${style.text}">${message}</span>`;

            // Mostrar
            alertBox.classList.remove('opacity-0', 'pointer-events-none');
            alertBox.classList.add('opacity-100', 'pointer-events-auto');

            // Ocultar autom√°ticamente
            alertTimeout = setTimeout(() => {
                alertBox.classList.remove('opacity-100', 'pointer-events-auto');
                alertBox.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }


        // --- Ejecuci√≥n Principal ---
        window.onload = function() {
            initThree();
            selectModel('Duck'); // Cargar modelo por defecto

            // Inicializar el modal de selecci√≥n como oculto
            toggleModelSelector(false);

            document.getElementById('placement-controls').classList.add('hidden'); 
            
            // Inicializar estado de 'Mover Modelo' como OFF (Rotar)
            controls.enabled = true; 
            document.getElementById('lock-status').textContent = 'OFF (Rotar)';
            
            // Establecer el estado inicial del panel como oculto y mostrar el icono de men√∫
            document.getElementById('control-panel').classList.remove('is-visible');
            document.getElementById('menu-icon').classList.remove('hidden');
            document.getElementById('close-icon').classList.add('hidden');
            isPanelVisible = false;

            animate();
        };

    </script>
</body>
</html>
