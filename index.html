<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>viewAR Minimal AR</title>
<style>
  body, html { margin: 0; padding: 0; overflow: hidden; background: #f0f0f0; }
  #ui {
    position: absolute; top: 10px; left: 10px; z-index: 10;
    display: flex; gap: 10px;
  }
  button { padding: 8px 12px; border:none; background:#333;color:white; border-radius:6px; cursor:pointer;}
  button:hover{opacity:0.8;}
</style>
</head>
<body>

<div id="ui">
  <button id="toggleTheme">Modo Oscuro</button>
  <button id="reubicBtn" style="display:none;">Reubicar</button>
  <button id="resetScaleBtn" style="display:none;">Reset Escala</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/DeviceOrientationControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
let scene, camera, renderer, controls;
let currentModel = null, modelContainer;
let placedOnce = false;
let isDarkMode = false;
let lastZ = 0, lastMotionZ = 0;

// ---------------- Scene ----------------
scene = new THREE.Scene();
camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
camera.position.set(0, 1.5, 3);

renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// ---------------- Light ----------------
const ambient = new THREE.AmbientLight(0xffffff, 0.8);
scene.add(ambient);
const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
dirLight.position.set(3,5,2);
scene.add(dirLight);

// ---------------- Controls ----------------
controls = new THREE.DeviceOrientationControls(camera);

// ---------------- Model Container ----------------
modelContainer = new THREE.Object3D();
scene.add(modelContainer);

// ---------------- Load Model ----------------
const loader = new THREE.GLTFLoader();
loader.load('modelo.glb', gltf => {
    currentModel = gltf.scene;
    currentModel.visible = false;
    currentModel.scale.set(1,1,1);
    modelContainer.add(currentModel);
});

// ---------------- AR Placement ----------------
let lastTapTime = 0;
function placeModelAtScreen(x, y){
    const pos = screenToWorld(x,y,2.5); // distancia fija
    modelContainer.position.copy(pos);
    modelContainer.rotation.set(0,0,0);
    currentModel.visible = true;
    placedOnce = true;
    document.getElementById('reubicBtn').style.display = 'block';
    document.getElementById('resetScaleBtn').style.display = 'block';
}

function screenToWorld(x, y, zDist){
    const vector = new THREE.Vector3(
        (x / window.innerWidth) * 2 - 1,
        -(y / window.innerHeight) * 2 + 1,
        0.5
    );
    vector.unproject(camera);
    const dir = vector.sub(camera.position).normalize();
    return camera.position.clone().add(dir.multiplyScalar(zDist));
}

// ---------------- Touch & Gesture ----------------
window.addEventListener('touchend', (e)=>{
    const now = Date.now();
    if(now - lastTapTime < 300){
        const t = e.changedTouches[0];
        placeModelAtScreen(t.clientX, t.clientY);
    }
    lastTapTime = now;
}, false);

let initialPinch = null;
window.addEventListener('touchmove', (e)=>{
    if(e.touches.length == 2 && currentModel){
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(initialPinch == null) initialPinch = dist;
        let scaleDelta = (dist - initialPinch) * 0.005;
        currentModel.scale.multiplyScalar(1 + scaleDelta);
        initialPinch = dist;
    }
});
window.addEventListener('touchend', ()=>{initialPinch = null;});

// ---------------- Device Motion ----------------
window.addEventListener('devicemotion', (e)=>{
    lastMotionZ = e.accelerationIncludingGravity.z || 0;
});

// ---------------- Update Anchor Effect ----------------
function updateAnchorEffect(){
    if(!placedOnce || !currentModel) return;
    const deltaZ = (lastMotionZ - lastZ) * 0.02;
    lastZ = lastMotionZ;
    modelContainer.position.z = THREE.MathUtils.clamp(modelContainer.position.z + deltaZ, -4, -1);
}

// ---------------- UI ----------------
document.getElementById('toggleTheme').addEventListener('click', ()=>{
    isDarkMode = !isDarkMode;
    document.body.style.background = isDarkMode ? '#111' : '#f0f0f0';
    document.getElementById('toggleTheme').innerText = isDarkMode ? 'Modo Claro' : 'Modo Oscuro';
});
document.getElementById('reubicBtn').addEventListener('click', ()=>{placedOnce=false; currentModel.visible=false;});
document.getElementById('resetScaleBtn').addEventListener('click', ()=>{if(currentModel) currentModel.scale.set(1,1,1);});

// ---------------- Animate ----------------
function animate(){
    requestAnimationFrame(animate);
    controls.update();
    updateAnchorEffect();
    renderer.render(scene,camera);
}
animate();

// ---------------- Resize ----------------
window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
