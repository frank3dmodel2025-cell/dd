<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor AR con Placement Dot — Galería</title>

  <!-- Tailwind y Three.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/DeviceOrientationControls.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f7f3ed;
      color: #3b4233;
      overflow: hidden;
      touch-action: none;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
    }
    video.video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 5;
      display: none;
    }
    /* Mismos estilos UI de tu código... */
    #placement-dot {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 62px;
      height: 62px;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      z-index: 22;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }
    #placement-dot .inner {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      border: 2px solid rgba(0, 0, 0, 0.45);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
    }
    #placement-dot .pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0, 128, 0, 0.12) 0%, rgba(0, 128, 0, 0.02) 60%, rgba(0, 128, 0, 0) 100%);
      animation: pulse 1.6s infinite;
      z-index: 1;
    }
    @keyframes pulse {
      0% { transform: scale(.95); opacity: 1 }
      70% { transform: scale(1.4); opacity: 0 }
      100% { opacity: 0 }
    }
  </style>
</head>
<body class="bg-gray-100 antialiased">

  <!-- Video passthrough -->
  <video id="video-feed" class="video-background" autoplay playsinline></video>

  <!-- 3D container -->
  <div id="three-container"></div>

  <!-- Placement dot (overlay) -->
  <div id="placement-dot" role="button" aria-label="Point to place model" tabindex="0">
    <div class="pulse"></div>
    <div class="inner"></div>
  </div>
  <div id="placement-hint">Mueve el punto. Doble tap para colocar.</div>

  <!-- UI y paneles de control acá (igual que en tu código) -->

<script type="module">
  let scene, camera, renderer, controls, gltfLoader;
  let modelContainer = null, currentModel = null;
  let deviceOrientationControls;
  
  let isARMode = false;
  let isMotionTrackingActive = false;
  
  const videoElement = document.getElementById('video-feed');
  const placementDot = document.getElementById('placement-dot');
  const placementHint = document.getElementById('placement-hint');

  const MODELS = {
    Duck: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF/Duck.gltf',
    Helmet: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF/DamagedHelmet.gltf',
    BoomBox: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/BoomBox/glTF/BoomBox.gltf'
  };

  function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 3); // camara atras viendo modelo

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('three-container').appendChild(renderer.domElement);

    const ambient = new THREE.AmbientLight(0xffffff, 1.5);
    scene.add(ambient);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(5, 5, 5);
    scene.add(dirLight);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enabled = true;  // inicialmente habilitado

    modelContainer = new THREE.Group();
    scene.add(modelContainer);

    gltfLoader = new THREE.GLTFLoader();

    deviceOrientationControls = new THREE.DeviceOrientationControls(camera);
    deviceOrientationControls.enabled = false;

    window.addEventListener('resize', onWindowResize);

    animate();
  }

  function loadModel(name) {
    if(currentModel) {
      modelContainer.remove(currentModel);
      disposeModel(currentModel);
      currentModel = null;
    }
    gltfLoader.load(MODELS[name], gltf => {
      currentModel = gltf.scene;
      const box = new THREE.Box3().setFromObject(currentModel);
      const center = box.getCenter(new THREE.Vector3());
      currentModel.position.sub(center);
      const size = box.getSize(new THREE.Vector3());
      const scaleFactor = 2 / Math.max(size.x, size.y, size.z);
      currentModel.scale.setScalar(scaleFactor);
      modelContainer.add(currentModel);
    });
  }

  function disposeModel(obj) {
    obj.traverse(child => {
      if(child.isMesh) {
        if(child.geometry) child.geometry.dispose();
        if(child.material) {
          if(Array.isArray(child.material)) child.material.forEach(m => m.dispose());
          else child.material.dispose();
        }
      }
    });
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function animate() {
    requestAnimationFrame(animate);
    if (isMotionTrackingActive) {
      deviceOrientationControls.update();
      controls.enabled = false; // desactivamos controles manuales para que no contradigan rotación
    } else {
      controls.enabled = true; // el usuario puede orbitar manualmente
    }
    renderer.render(scene, camera);
  }

  async function toggleMotionTrackingEnable() {
    if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
      try {
        const permission = await DeviceOrientationEvent.requestPermission();
        if(permission === "granted"){
          enableMotionTracking();
        } else {
          alert("Permiso para sensores denegado");
        }
      } catch(e) {
        alert("Error solicitando permiso para sensores");
      }
    } else {
      enableMotionTracking();
    }
  }

  function enableMotionTracking() {
    deviceOrientationControls.enabled = true;
    deviceOrientationControls.connect();
    isMotionTrackingActive = true;
    controls.enabled = false;
  }

  function disableMotionTracking() {
    deviceOrientationControls.disconnect();
    deviceOrientationControls.enabled = false;
    isMotionTrackingActive = false;
    controls.enabled = true;
  }

  window.onload = () => {
    initThree();
    loadModel('Duck');

    // Para activar mode tracking por defecto si quieres
    // toggleMotionTrackingEnable();

    // Ejemplo botón o activador para activar/desactivar rastreo:
    document.body.insertAdjacentHTML('beforeend', `
      <button id="toggleTrackBtn" style="position:fixed;top:10px;left:10px;z-index:1000;padding:0.5em 1em;">Alternar rastreo motion</button>
    `);
    document.getElementById('toggleTrackBtn').addEventListener('click', () => {
      if(isMotionTrackingActive) disableMotionTracking();
      else toggleMotionTrackingEnable();
    });
  };
</script>
</body>
</html>
