<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor 3D Interactivo Elegante</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Three.js y dependencias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Base styles and custom scrollbar for dark theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* dark-bg */
            overflow: hidden; /* Prevent scrolling */
        }
        /* Custom scrollbar for control panel */
        .glass-panel::-webkit-scrollbar {
            width: 8px;
        }
        .glass-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .glass-panel::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.7); /* accent-color */
            border-radius: 10px;
        }
        .glass-panel::-webkit-scrollbar-thumb:hover {
            background: #4f46e5;
        }
    </style>
    <script>
        // Configuración de Tailwind para colores personalizados
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#0f172a',
                        'card-bg': 'rgba(46, 52, 64, 0.95)',
                        'accent-color': '#4f46e5', // Indigo
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-bg text-white">

    <!-- Contenedor principal de la aplicación -->
    <div id="app-container" class="w-screen h-screen relative">
        <!-- Canvas de Three.js (será inicializado por JS) -->
        <div id="three-canvas-container" class="w-full h-full"></div>

        <!-- 1. Alerta Personalizada (Notificación) -->
        <div id="alert-box" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-4 rounded-xl shadow-2xl z-50 transition-opacity duration-300 pointer-events-none opacity-0
            bg-card-bg backdrop-blur-md border border-gray-700/50" role="alert">
            <p id="alert-message" class="text-white text-lg font-semibold"></p>
        </div>

        <!-- 2. Botón de Menú (Hamburguesa) - Superior Izquierda -->
        <button id="menu-toggle-btn"
            class="fixed top-4 left-4 p-3 bg-accent-color rounded-full shadow-lg hover:bg-indigo-600 transition duration-200 z-30"
            onclick="togglePanelVisibility()">
            <!-- Icono de Hamburguesa (SVG de lucide-react, simulado) -->
            <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-white">
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
            </svg>
            <!-- Icono de Cierre (X) - Oculto inicialmente -->
            <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-white hidden">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>


        <!-- 3. Panel de Controles (Glassmorphism) - Superior Izquierda -->
        <div id="control-panel"
             class="glass-panel fixed top-4 left-4 w-72 h-[calc(100vh-2rem)] rounded-2xl shadow-2xl p-6 z-20
                    bg-card-bg backdrop-blur-sm border border-gray-700/50 transform -translate-x-full transition-transform duration-300 overflow-y-auto">
            
            <h2 class="text-2xl font-bold mb-6 text-accent-color">Controles 3D</h2>

            <!-- Información del Modelo -->
            <div class="mb-6 pb-4 border-b border-gray-700/50">
                <p class="text-sm text-gray-400 mb-1">Modelo Actual:</p>
                <p id="current-model-name" class="text-xl font-semibold">Duck</p>
            </div>

            <!-- Grupo de Controles: Navegación y Zoom -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 border-b border-gray-700/50 pb-1">Navegación</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button class="control-btn" onclick="zoomCamera(1.1)">
                        Zoom +
                    </button>
                    <button class="control-btn" onclick="zoomCamera(0.9)">
                        Zoom -
                    </button>
                </div>
            </div>

            <!-- Grupo de Controles: Escala -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 border-b border-gray-700/50 pb-1">Escala</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button class="control-btn" onclick="scaleModel(1.2)">
                        Escala +
                    </button>
                    <button class="control-btn" onclick="scaleModel(0.8)">
                        Escala -
                    </button>
                </div>
            </div>

            <!-- Grupo de Controles: Toggles -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 border-b border-gray-700/50 pb-1">Modos</h3>
                <div class="space-y-4">
                    <button id="toggle-rotate-btn" class="control-btn w-full" onclick="toggleAutoRotate()">
                        Rotación Automática: <span id="auto-rotate-status">OFF</span>
                    </button>
                    <button id="toggle-lock-btn" class="control-btn w-full" onclick="toggleLockModel()">
                        Bloquear Modelo: <span id="lock-status">OFF</span>
                    </button>
                </div>
            </div>

            <!-- Grupo de Controles: Fondo / Realidad Aumentada (Modo Pared) -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 border-b border-gray-700/50 pb-1">Simulación AR</h3>
                <button id="toggle-placement-btn" class="control-btn w-full bg-pink-700/80 hover:bg-pink-600" onclick="togglePlacementMode()">
                    Modo Pared (AR): <span id="placement-status">OFF</span>
                </button>
                <p class="text-xs text-gray-400 mt-2 italic">Requiere permiso de la cámara.</p>
            </div>
            
            <div class="text-center mt-8">
                <p class="text-sm text-gray-500">Visor 3D Propulsado por Three.js</p>
            </div>

        </div>

        <!-- 4. Carrusel de Modelos (Glassmorphism) - Inferior Central -->
        <div id="carousel"
             class="fixed bottom-6 left-1/2 transform -translate-x-1/2 rounded-2xl shadow-2xl p-4 z-20
                    bg-card-bg backdrop-blur-sm border border-gray-700/50 flex space-x-4 transition-all duration-300 opacity-0 pointer-events-none">
            
            <h3 class="text-lg font-semibold my-auto pr-4 border-r border-gray-700/50 text-gray-300">Modelos</h3>

            <!-- Elementos del Carrusel -->
            <div class="flex space-x-3">
                <button class="carousel-item" data-model="Duck" onclick="selectModel('Duck')">
                    <div class="w-16 h-16 rounded-lg bg-indigo-500/30 flex items-center justify-center text-xs font-bold ring-2 ring-accent-color transition-all">
                        Pato
                    </div>
                    <span class="mt-1 text-sm">Duck</span>
                </button>
                <button class="carousel-item" data-model="Helmet" onclick="selectModel('Helmet')">
                    <div class="w-16 h-16 rounded-lg bg-gray-500/30 flex items-center justify-center text-xs font-bold transition-all">
                        Casco
                    </div>
                    <span class="mt-1 text-sm">Helmet</span>
                </button>
                <button class="carousel-item" data-model="BoomBox" onclick="selectModel('BoomBox')">
                    <div class="w-16 h-16 rounded-lg bg-red-500/30 flex items-center justify-center text-xs font-bold transition-all">
                        Bocina
                    </div>
                    <span class="mt-1 text-sm">BoomBox</span>
                </button>
            </div>
        </div>

    </div>

    <script>
        // Definición de Clases de Botones para reutilización
        const CONTROL_BTN_CLASSES = 'px-4 py-2 rounded-lg bg-accent-color/80 hover:bg-accent-color transition duration-200 font-medium text-sm shadow-md';
        document.querySelectorAll('.control-btn').forEach(btn => btn.className += ' ' + CONTROL_BTN_CLASSES);
        
        // --- Variables de Three.js y Configuración de Posición ---
        let scene, camera, renderer, controls;
        let loader, currentModel = null;
        let video = null; // Para el fondo AR
        let videoTexture = null;
        
        let isPlacementModeActive = false; // Nuevo estado global para el modo pared

        // Rutas de los modelos glTF de ejemplo de Khronos (pueden requerir CORS)
        const MODEL_PATHS = {
            'Duck': 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
            'Helmet': 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/DamagedHelmet/glTF/DamagedHelmet.gltf',
            'BoomBox': 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/BoomBox/glTF/BoomBox.gltf'
        };

        // Constantes para posiciones de Cámara y Target
        const DEFAULT_CAMERA_POS = new THREE.Vector3(0, 1.5, 4);
        const DEFAULT_TARGET_POS = new THREE.Vector3(0, 0, 0);

        // Configuración para el "Modo Pared" (Ilusión AR)
        const PLACEMENT_CAMERA_POS = new THREE.Vector3(0, 1.3, 0.5); // Cámara cerca de la "pared" (Z=0.5)
        const PLACEMENT_TARGET_POS = new THREE.Vector3(0, 1.3, -2.5); // Mirando al modelo en la "pared"
        const PLACEMENT_MODEL_OFFSET = new THREE.Vector3(0, 0, -2.5); // El modelo se mueve a Z=-2.5 (la "pared")

        // Estado del UI
        let isPanelVisible = false;

        // --- Inicialización de Three.js ---
        function initThree() {
            // 1. Configuración de la Escena
            scene = new THREE.Scene();

            // 2. Configuración de la Cámara
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.copy(DEFAULT_CAMERA_POS); // Posición inicial

            // 3. Configuración del Renderizador
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('three-canvas-container').appendChild(renderer.domElement);

            // 4. Iluminación
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            // 5. Controles de Órbita
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.target.copy(DEFAULT_TARGET_POS);

            // 6. Loader
            loader = new THREE.GLTFLoader();

            // 7. Manejo de Redimensionamiento
            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Bucle de Animación ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // Necesario si controls.enableDamping está activado
            if (videoTexture) videoTexture.needsUpdate = true; // Actualizar textura de video si está activa
            renderer.render(scene, camera);
        }
        
        // --- Funcionalidad de Carga de Modelos ---
        function loadModel(url, modelName) {
            alertMessage(`Cargando modelo: ${modelName}...`);

            // 1. Remover modelo anterior
            if (currentModel) {
                scene.remove(currentModel);
                currentModel = null;
            }

            // 2. Cargar nuevo modelo
            loader.load(
                url,
                (gltf) => {
                    currentModel = gltf.scene;
                    
                    // Centrar y escalar el modelo para que encaje
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const size = box.getSize(new THREE.Vector3()).length();
                    const center = box.getCenter(new THREE.Vector3());
                    
                    currentModel.position.sub(center); // Centrar el pivote del modelo en (0,0,0)

                    // Escalar el modelo para que se vea bien
                    const scaleFactor = 4 / size; 
                    currentModel.scale.set(scaleFactor, scaleFactor, scaleFactor);
                    
                    scene.add(currentModel);
                    
                    // Si el modo pared está activo, aplicar inmediatamente el desplazamiento
                    if (isPlacementModeActive) {
                        currentModel.position.copy(PLACEMENT_MODEL_OFFSET);
                    } else {
                        // Asegurar posición central en modo normal
                        currentModel.position.set(0, 0, 0);
                    }

                    alertMessage(`Modelo "${modelName}" cargado con éxito.`);
                },
                (xhr) => {
                    // Progreso de carga
                    // console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                (error) => {
                    console.error('Error cargando modelo:', error);
                    alertMessage(`ERROR: No se pudo cargar el modelo "${modelName}".`, 'error');
                }
            );
        }

        function selectModel(modelName) {
            const url = MODEL_PATHS[modelName];
            if (url) {
                loadModel(url, modelName);
                document.getElementById('current-model-name').textContent = modelName;
                
                // Actualizar estilo del carrusel para indicar el modelo activo
                document.querySelectorAll('.carousel-item > div').forEach(div => {
                    div.classList.remove('ring-2', 'ring-accent-color');
                });
                document.querySelector(`[data-model="${modelName}"] > div`).classList.add('ring-2', 'ring-accent-color');

            } else {
                alertMessage('Modelo no encontrado.', 'error');
            }
        }

        // --- Funcionalidad de Controles UI ---
        
        // 1. Alternar Visibilidad del Panel y Carrusel
        function togglePanelVisibility() {
            const panel = document.getElementById('control-panel');
            const carousel = document.getElementById('carousel');
            const menuIcon = document.getElementById('menu-icon');
            const closeIcon = document.getElementById('close-icon');

            isPanelVisible = !isPanelVisible;

            if (isPanelVisible) {
                // Mostrar panel y carrusel
                panel.classList.remove('-translate-x-full');
                carousel.classList.remove('opacity-0', 'pointer-events-none');
                carousel.classList.add('opacity-100', 'pointer-events-auto');
                menuIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
            } else {
                // Ocultar panel y carrusel
                panel.classList.add('-translate-x-full');
                carousel.classList.remove('opacity-100', 'pointer-events-auto');
                carousel.classList.add('opacity-0', 'pointer-events-none');
                menuIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            }
        }

        // 2. Zoom de Cámara (Aplica en ambos modos, afectando la distancia al target)
        function zoomCamera(factor) {
            if (!controls) return;
            
            // Usar la posición actual como referencia, manteniendo el target
            const currentDistance = camera.position.distanceTo(controls.target);
            const newDistance = currentDistance * factor;
            
            // Límite para evitar zoom excesivo
            if (newDistance > 0.5 && newDistance < 100) {
                const direction = new THREE.Vector3().subVectors(camera.position, controls.target).normalize();
                camera.position.copy(controls.target).add(direction.multiplyScalar(newDistance));
                controls.update();
                alertMessage(factor > 1 ? 'Acercando Zoom' : 'Alejando Zoom');
            } else {
                alertMessage('Límite de Zoom alcanzado.', 'info');
            }
        }

        // 3. Escala del Modelo
        function scaleModel(factor) {
            if (!currentModel) {
                alertMessage('Cargue un modelo primero.', 'warning');
                return;
            }
            currentModel.scale.multiplyScalar(factor);
            alertMessage(factor > 1 ? 'Aumentando Escala' : 'Reduciendo Escala');
        }

        // 4. Rotación Automática
        function toggleAutoRotate() {
            controls.autoRotate = !controls.autoRotate;
            const statusText = controls.autoRotate ? 'ON' : 'OFF';
            document.getElementById('auto-rotate-status').textContent = statusText;
            alertMessage(`Rotación Automática: ${statusText}`);
        }

        // 5. Bloquear Modelo (Desactivar OrbitControls)
        function toggleLockModel() {
            controls.enabled = !controls.enabled;
            const statusText = controls.enabled ? 'OFF' : 'ON'; // ON cuando controls está DESHABILITADO
            document.getElementById('lock-status').textContent = controls.enabled ? 'OFF' : 'ON';
            alertMessage(`Modelo Bloqueado: ${controls.enabled ? 'NO' : 'SÍ'}`);
        }
        
        // 6. Modo Pared (Simulación AR)
        async function togglePlacementMode() {
            const btn = document.getElementById('toggle-placement-btn');
            const status = document.getElementById('placement-status');

            if (isPlacementModeActive) {
                // --- Desactivar Modo Colocación ---
                isPlacementModeActive = false;
                
                // 1. Detener Video/Cámara
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                video = null;
                videoTexture = null;

                // 2. Restaurar Escena
                scene.background = new THREE.Color(0x0f172a); 
                
                // 3. Restaurar Cámara y Modelo
                camera.position.copy(DEFAULT_CAMERA_POS);
                controls.target.copy(DEFAULT_TARGET_POS);
                controls.update();
                if (currentModel) currentModel.position.set(0, 0, 0);
                
                // 4. Actualizar UI
                status.textContent = 'OFF';
                btn.classList.remove('bg-green-600', 'hover:bg-green-500');
                btn.classList.add('bg-pink-700/80', 'hover:bg-pink-600');
                alertMessage('Modo Pared Desactivado.');

            } else {
                // --- Activar Modo Colocación ---
                try {
                    // 1. Iniciar Video/Cámara
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' } 
                    });
                    
                    video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    
                    videoTexture = new THREE.VideoTexture(video);
                    
                    // 2. Configurar Escena para AR Illusion
                    scene.background = videoTexture;
                    
                    // 3. Configurar Cámara y Modelo
                    if (currentModel) currentModel.position.copy(PLACEMENT_MODEL_OFFSET);
                    camera.position.copy(PLACEMENT_CAMERA_POS);
                    controls.target.copy(PLACEMENT_TARGET_POS);
                    controls.update();

                    // 4. Actualizar UI
                    isPlacementModeActive = true;
                    status.textContent = 'ON';
                    btn.classList.remove('bg-pink-700/80', 'hover:bg-pink-600');
                    btn.classList.add('bg-green-600', 'hover:bg-green-500');
                    alertMessage('Modo Pared Activado (Cámara en uso).', 'success');

                } catch (err) {
                    console.error('Error al acceder a la cámara:', err);
                    alertMessage('ERROR: No se pudo acceder a la cámara o permisos denegados.', 'error');
                }
            }
        }


        // 7. Sistema de Alerta Personalizada
        let alertTimeout = null;
        function alertMessage(message, type = 'info') {
            const alertBox = document.getElementById('alert-box');
            const alertMsg = document.getElementById('alert-message');

            // Limpiar timeout anterior
            if (alertTimeout) {
                clearTimeout(alertTimeout);
            }

            // Aplicar estilo basado en el tipo
            let baseClasses = 'text-white text-lg font-semibold';
            alertBox.className = alertBox.className.replace(/border-(red|green|yellow|gray)-\d{3}\/50/g, 'border-gray-700/50');
            
            if (type === 'success') {
                alertBox.classList.add('border-green-300/50');
                alertMsg.innerHTML = `<span class="text-green-300 mr-2">✓</span> ${message}`;
            } else if (type === 'error') {
                alertBox.classList.add('border-red-300/50');
                alertMsg.innerHTML = `<span class="text-red-300 mr-2">✗</span> ${message}`;
            } else if (type === 'warning') {
                alertBox.classList.add('border-yellow-300/50');
                alertMsg.innerHTML = `<span class="text-yellow-300 mr-2">!</span> ${message}`;
            } else {
                alertBox.classList.add('border-gray-300/50');
                alertMsg.innerHTML = message;
            }

            // Mostrar
            alertBox.classList.remove('opacity-0', 'pointer-events-none');
            alertBox.classList.add('opacity-100', 'pointer-events-auto');

            // Ocultar automáticamente después de 3 segundos
            alertTimeout = setTimeout(() => {
                alertBox.classList.remove('opacity-100', 'pointer-events-auto');
                alertBox.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }


        // --- Ejecución Principal ---
        window.onload = function() {
            initThree();
            selectModel('Duck'); // Cargar modelo por defecto

            // Ocultar los paneles al inicio para mantener el estado inicial
            document.getElementById('control-panel').classList.add('-translate-x-full');
            document.getElementById('carousel').classList.add('opacity-0', 'pointer-events-none');

            // Asegurar que el botón de menú sea visible
            document.getElementById('menu-icon').classList.remove('hidden');
            document.getElementById('close-icon').classList.add('hidden');
            
            animate();
        };

    </script>
</body>
</html>
